      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (e) {
        console.error(e);
        alert('Giriş hatası: ' + e.message);
      }
    });

    // Oturum durumunu izle
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        authButtons.innerHTML = `<div style="font-size:13px">${user.email} <button id=btnLogout style="margin-left:8px;background:#ef4444">Çıkış</button></div>`;
        document.getElementById('btnLogout').onclick = () => signOut(auth);

        const udoc = await getDoc(doc(db, 'users', user.uid));
        const ubal = udoc.exists() ? udoc.data().balance || 0 : 0;
        balanceEl.textContent = `Bakiye: ₺${ubal}`;
        taskListCard.style.display = 'block';

        if (user.email === ADMIN_EMAIL) adminCard.style.display = 'block'; else adminCard.style.display = 'none';

        startTasksListener();
      } else {
        authButtons.innerHTML = '';
        balanceEl.textContent = 'Bakiye: ₺0';
        taskListCard.style.display = 'none';
        adminCard.style.display = 'none';
      }
    });

    // Görevleri dinle
    let unsubscribeTasks = null;
    function startTasksListener() {
      if (unsubscribeTasks) unsubscribeTasks();
      const tasksCol = collection(db, 'tasks');
      unsubscribeTasks = onSnapshot(tasksCol, (snap) => {
        tasksDiv.innerHTML = '';
        snap.forEach(docSnap => {
          const t = { id: docSnap.id, ...docSnap.data() };
          renderTask(t);
        });
      });
    }

    // Görev gösterimi
    function renderTask(task) {
      const el = document.createElement('div');
      el.className = 'card';
      el.innerHTML = `<div><strong>${escapeHtml(task.title)}</strong></div><div class="small muted">${escapeHtml(task.description || '')}</div><div style="margin-top:8px">Ödül: ₺${task.reward}</div>`;

      const actions = document.createElement('div'); actions.className = 'task-actions';
      const btn = document.createElement('button'); btn.textContent = 'Tamamla';

      btn.onclick = () => {
        showPaymentModal(task.id, task.reward);
      };

      actions.appendChild(btn);
      el.appendChild(actions);
      tasksDiv.appendChild(el);
    }

    // Görev tamamlama (ödeme yöntemi ile)
    async function completeTaskWithPayment(taskId, reward, paymentMethod) {
      const user = auth.currentUser;
      if (!user) { alert('Lütfen giriş yapın'); return; }
      try {
        const compRef = doc(db, 'users', user.uid, 'completions', taskId);
        const compSnap = await getDoc(compRef);
        if (compSnap.exists()) { alert('Bu görevi zaten tamamladınız.'); return; }

        await setDoc(compRef, { taskId, completedAt: new Date().toISOString(), reward: Number(reward), paymentMethod });

        const userRef = doc(db, 'users', user.uid);
        await updateDoc(userRef, { balance: increment(Number(reward)) });

        const newUserSnap = await getDoc(userRef);
        const newBal = newUserSnap.data().balance;
        balanceEl.textContent = `Bakiye: ₺${newBal}`;
        alert(`Tebrikler! Görev tamamlandı ve bakiye eklendi.\nÖdeme Yöntemi: ${paymentMethod}`);
      } catch (e) {
        console.error(e);
        alert('Tamamlama hatası: ' + e.message);
      }
    }

    // Ödeme modal fonksiyonları
    function showPaymentModal(taskId, reward) {
      pendingTaskId = taskId;
      pendingReward = reward;
      paymentMethodSelect.value = "";
      paymentModal.style.display = "flex";
    }

    confirmPaymentBtn.onclick = async () => {
      const method = paymentMethodSelect.value;
      if (!method) {
        alert("Lütfen bir ödeme yöntemi seçin.");
        return;
      }
      paymentModal.style.display = "none";

      await completeTaskWithPayment(pendingTaskId, pendingReward, method);
      pendingTaskId = null;
      pendingReward = 0;
    };

    cancelPaymentBtn.onclick = () => {
      paymentModal.style.display = "none";
      pendingTaskId = null;
      pendingReward = 0;
    };

    // Admin: Görev ekleme
    document.getElementById('btnAddTask').addEventListener('click', async () => {
      const title = document.getElementById('taskTitle').value.trim();
      const desc = document.getElementById('taskDesc').value.trim();
      const reward = Number(document.getElementById('taskReward').value);
      if (!title || !reward) { alert('Başlık ve ödül gerekli'); return; }
      try {
        await addDoc(collection(db, 'tasks'), { title: title, description: desc, reward: reward, createdAt: new Date().toISOString() });
        document.getElementById('taskTitle').value = ''; document.getElementById('taskDesc').value = ''; document.getElementById('taskReward').value = '';
        alert('Görev eklendi');
      } catch (e) {
        console.error(e);
        alert('Ekleme hatası: ' + e.message);
      }
    });

    // Basit HTML kaçış fonksiyonu
    function escapeHtml(text) {
      if (!text) return '';
      return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }
  </script>
</body>
</html>
