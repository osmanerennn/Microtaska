<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MikroGÃ¶rev - Telefon Uyumlu PWA (Demo)</title>  
  <style>
    :root{--accent:#0ea5a4}
    body{font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif; margin:0; background:#f3f4f6; color:#111}
    header{background:var(--accent); color:white; padding:18px 14px; display:flex; align-items:center; justify-content:space-between}
    main{padding:14px}
    .card{background:white;border-radius:12px;padding:12px;margin-bottom:12px;box-shadow:0 1px 3px rgba(0,0,0,0.06)}
    button{background:var(--accent);color:white;border:none;padding:10px 12px;border-radius:8px;font-weight:600; cursor:pointer;}
    input, button.select, textarea, select{font-size:16px;padding:8px;border-radius:8px;border:1px solid #e5e7eb;width:100%;box-sizing:border-box}
    .row{display:flex;gap:8px}
    .small{font-size:13px;color:#6b7280}
    .muted{color:#6b7280}
    .task-actions{display:flex;gap:8px;margin-top:8px}
    nav a{color:white;text-decoration:none;font-weight:600}
    footer{padding:12px;text-align:center;color:#6b7280;font-size:13px}

    /* Ã–deme Modal */
    #paymentModal {
      display:none; 
      position:fixed; top:0; left:0; width:100%; height:100%; 
      background:rgba(0,0,0,0.5); 
      justify-content:center; 
      align-items:center;
      z-index:1000;
    }
    #paymentModal > div {
      background:#fff; padding:20px; border-radius:10px; width:90%; max-width:320px; text-align:center;
    }
  </style>  
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0ea5a4">
</head>
<body>
  <header>
    <div>
      <div style="font-size:18px;font-weight:700">ğŸ“± MikroGÃ¶rev</div>
      <div style="font-size:12px;opacity:0.95">0â‚º baÅŸlangÄ±Ã§ - telefon tarayÄ±cÄ±sÄ±nda Ã§alÄ±ÅŸÄ±r</div>
    </div>
    <div id="userArea" style="text-align:right">
      <div class="muted" id="balance">Bakiye: â‚º0</div>
      <div id="authButtons"></div>
    </div>
  </header>  
  <main>
    <div id="app">
      <div id="authCard" class="card">
        <h3>GiriÅŸ / KayÄ±t</h3>
        <div class="row" style="margin-top:8px">
          <input id="email" placeholder="E-posta" />
        </div>
        <div style="margin-top:8px">
          <input id="password" type="password" placeholder="Parola" />
        </div>
        <div style="margin-top:8px" class="row">
          <button id="btnSignUp">KayÄ±t Ol</button>
          <button id="btnSignIn" style="background:#4b5563">GiriÅŸ Yap</button>
        </div>
        <div class="small" style="margin-top:8px">Demo: GerÃ§ek Ã¶deme entegrasyonu iÃ§in ek adÄ±mlar gerekir.</div>
      </div>

      <div id="taskListCard" class="card" style="display:none">
        <h3>Mevcut GÃ¶revler</h3>
        <div id="tasks"></div>
      </div>

      <div id="adminCard" class="card" style="display:none">
        <h3>Admin: GÃ¶rev Ekle</h3>
        <input id="taskTitle" placeholder="GÃ¶rev baÅŸlÄ±ÄŸÄ± (Ã¶r. Instagram beÄŸeni)" />
        <input id="taskReward" placeholder="Ã–dÃ¼l (sadece sayÄ±, â‚º)" style="margin-top:8px" />
        <textarea id="taskDesc" placeholder="KÄ±sa aÃ§Ä±klama (isteÄŸe baÄŸlÄ±)" style="margin-top:8px"></textarea>
        <div style="margin-top:8px" class="row">
          <button id="btnAddTask">GÃ¶rev Ekle</button>
        </div>
        <div class="small" style="margin-top:8px">Bu panel yalnÄ±zca admin e-posta ile gÃ¶rÃ¼nÃ¼r. GÃ¼venlik iÃ§in Firestore kurallarÄ± yapÄ±landÄ±rÄ±lmalÄ±dÄ±r.</div>
      </div>
    </div>
  </main>  
  <footer>
    Bu bir demo uygulamadÄ±r. Ãœcretli Ã¶demeler manuel onayla yapÄ±lÄ±r. Hizmet ÅŸartlarÄ± ve veritabanÄ± gÃ¼venliÄŸi yapÄ±landÄ±rÄ±lmalÄ±dÄ±r.
  </footer>  

  <!-- Ã–deme Modal -->
  <div id="paymentModal">
    <div>
      <h3>Ã–deme YÃ¶ntemi SeÃ§</h3>
      <select id="paymentMethod">
        <option value="">SeÃ§iniz</option>
        <option value="PayPal">PayPal</option>
        <option value="Papara">Papara</option>
        <option value="Banka Havalesi">Banka Havalesi</option>
      </select>
      <button id="confirmPaymentBtn" style="margin-top:12px;">Onayla</button>
      <button id="cancelPaymentBtn" style="margin-left:10px; background:#ef4444;">Ä°ptal</button>
    </div>
  </div>

  <!-- Firebase & App Script -->
  <script type="module">
    // Firebase config - kendi bilgilerinle deÄŸiÅŸtir!
    const firebaseConfig = {
      apiKey: "AIzaSyD2uaLK4sAIAfBGHzN9936pxIyCtYH8qgQ",
      authDomain: "katsi-afdae.firebaseapp.com",
      projectId: "katsi-afdae",
      storageBucket: "katsi-afdae.firebasestorage.app",
      messagingSenderId: "864000378641",
      appId: "1:864000378641:web:cfe5ac6e48cf6ee59eaeb0",
      measurementId: "G-SSHDZGL4P7"
    };

    // Admin e-posta - deÄŸiÅŸtir kendine gÃ¶re
    const ADMIN_EMAIL = "you@yourdomain.com";

    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js';
    import { getFirestore, collection, addDoc, doc, getDocs, query, where, onSnapshot, updateDoc, increment, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // UI elementleri
    const emailEl = document.getElementById('email');
    const passwordEl = document.getElementById('password');
    const btnSignUp = document.getElementById('btnSignUp');
    const btnSignIn = document.getElementById('btnSignIn');
    const authButtons = document.getElementById('authButtons');
    const balanceEl = document.getElementById('balance');
    const tasksDiv = document.getElementById('tasks');
    const taskListCard = document.getElementById('taskListCard');
    const adminCard = document.getElementById('adminCard');

    // Ã–deme modal elementleri
    const paymentModal = document.getElementById('paymentModal');
    const paymentMethodSelect = document.getElementById('paymentMethod');
    const confirmPaymentBtn = document.getElementById('confirmPaymentBtn');
    const cancelPaymentBtn = document.getElementById('cancelPaymentBtn');

    let pendingTaskId = null;
    let pendingReward = 0;

    // KayÄ±t ol
    btnSignUp.addEventListener('click', async () => {
      const email = emailEl.value.trim();
      const password = passwordEl.value;
      if (!email || !password) { alert('Email ve parola gerekli'); return; }
      try {
        const userCred = await createUserWithEmailAndPassword(auth, email, password);
        await setDoc(doc(db, 'users', userCred.user.uid), { email: email, balance: 0 });
        alert('KayÄ±t baÅŸarÄ±lÄ±!');
      } catch (e) {
        console.error(e);
        alert('KayÄ±t hatasÄ±: ' + e.message);
      }
    });

    // GiriÅŸ yap
    btnSignIn.addEventListener('click', async () => {
      const email = emailEl.value.trim();
      const password = passwordEl.value;
      if (!email || !password) { alert('Email ve parola gerekli'); return; }
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (e) {
        console.error(e);
        alert('GiriÅŸ hatasÄ±: ' + e.message);
      }
    });

    // Oturum durumunu izle
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        authButtons.innerHTML = `<div style="font-size:13px">${user.email} <button id=btnLogout style="margin-left:8px;background:#ef4444">Ã‡Ä±kÄ±ÅŸ</button></div>`;
        document.getElementById('btnLogout').onclick = () => signOut(auth);

        const udoc = await getDoc(doc(db, 'users', user.uid));
        const ubal = udoc.exists() ? udoc.data().balance || 0 : 0;
        balanceEl.textContent = `Bakiye: â‚º${ubal}`;
        taskListCard.style.display = 'block';

        if (user.email === ADMIN_EMAIL) adminCard.style.display = 'block'; else adminCard.style.display = 'none';

        startTasksListener();
      } else {
        authButtons.innerHTML = '';
        balanceEl.textContent = 'Bakiye: â‚º0';
        taskListCard.style.display = 'none';
        adminCard.style.display = 'none';
      }
    });

    // GÃ¶revleri dinle
    let unsubscribeTasks = null;
    function startTasksListener() {
      if (unsubscribeTasks) unsubscribeTasks();
      const tasksCol = collection(db, 'tasks');
      unsubscribeTasks = onSnapshot(tasksCol, (snap) => {
        tasksDiv.innerHTML = '';
        snap.forEach(docSnap => {
          const t = { id: docSnap.id, ...docSnap.data() };
          renderTask(t);
        });
      });
    }

    // GÃ¶rev gÃ¶sterimi
    function renderTask(task) {
      const el = document.createElement('div');
      el.className = 'card';
      el.innerHTML = `<div><strong>${escapeHtml(task.title)}</strong></div><div class="small muted">${escapeHtml(task.description || '')}</div><div style="margin-top:8px">Ã–dÃ¼l: â‚º${task.reward}</div>`;

      const actions = document.createElement('div'); actions.className = 'task-actions';
      const btn = document.createElement('button'); btn.textContent = 'Tamamla';

      btn.onclick = () => {
        showPaymentModal(task.id, task.reward);
      };

      actions.appendChild(btn);
      el.appendChild(actions);
      tasksDiv.appendChild(el);
    }

    // GÃ¶rev tamamlama (Ã¶deme yÃ¶ntemi ile)
    async function completeTaskWithPayment(taskId, reward, paymentMethod) {
      const user = auth.currentUser;
      if (!user) { alert('LÃ¼tfen giriÅŸ yapÄ±n'); return; }
      try {
        const compRef = doc(db, 'users', user.uid, 'completions', taskId);
        const compSnap = await getDoc(compRef);
        if (compSnap.exists()) { alert('Bu gÃ¶revi zaten tamamladÄ±nÄ±z.'); return; }

        await setDoc(compRef, { taskId, completedAt: new Date().toISOString(), reward: Number(reward), paymentMethod });

        const userRef = doc(db, 'users', user.uid);
        await updateDoc(userRef, { balance: increment(Number(reward)) });

        const newUserSnap = await getDoc(userRef);
        const newBal = newUserSnap.data().balance;
        balanceEl.textContent = `Bakiye: â‚º${newBal}`;
        alert(`Tebrikler! GÃ¶rev tamamlandÄ± ve bakiye eklendi.\nÃ–deme YÃ¶ntemi: ${paymentMethod}`);
      } catch (e) {
        console.error(e);
        alert('Tamamlama hatasÄ±: ' + e.message);
      }
    }

    // Ã–deme modal fonksiyonlarÄ±
    function showPaymentModal(taskId, reward) {
      pendingTaskId = taskId;
      pendingReward = reward;
      paymentMethodSelect.value = "";
      paymentModal.style.display = "flex";
    }

    confirmPaymentBtn.onclick = async () => {
      const method = paymentMethodSelect.value;
      if (!method) {
        alert("LÃ¼tfen bir Ã¶deme yÃ¶ntemi seÃ§in.");
        return;
      }
      paymentModal.style.display = "none";

      await completeTaskWithPayment(pendingTaskId, pendingReward, method);
      pendingTaskId = null;
      pendingReward = 0;
    };

    cancelPaymentBtn.onclick = () => {
      paymentModal.style.display = "none";
      pendingTaskId = null;
      pendingReward = 0;
    };

    // Admin: GÃ¶rev ekleme
    document.getElementById('btnAddTask').addEventListener('click', async () => {
      const title = document.getElementById('taskTitle').value.trim();
      const desc = document.getElementById('taskDesc').value.trim();
      const reward = Number(document.getElementById('taskReward').value);
      if (!title || !reward) { alert('BaÅŸlÄ±k ve Ã¶dÃ¼l gerekli'); return; }
      try {
        await addDoc(collection(db, 'tasks'), { title: title, description: desc, reward: reward, createdAt: new Date().toISOString() });
        document.getElementById('taskTitle').value = ''; document.getElementById('taskDesc').value = ''; document.getElementById('taskReward').value = '';
        alert('GÃ¶rev eklendi');
      } catch (e) {
        console.error(e);
        alert('Ekleme hatasÄ±: ' + e.message);
      }
    });

    // Basit HTML kaÃ§Ä±ÅŸ fonksiyonu
    function escapeHtml(text) {
      if (!text) return '';
      return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }
  </script>
</body>
</html>
