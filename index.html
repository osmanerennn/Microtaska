      apiKey: "AIzaSyD2uaLK4sAIAfBGHzN9936pxIyCtYH8qgQ",
      authDomain: "katsi-afdae.firebaseapp.com",
      projectId: "katsi-afdae",
      storageBucket: "katsi-afdae.appspot.com",
      messagingSenderId: "864000378641",
      appId: "1:864000378641:web:cfe5ac6e48cf6ee59eaeb0",
      measurementId: "G-SSHDZGL4P7"
    };

    const ADMIN_EMAIL = "admin@example.com"; // Buraya admin e-postanı yaz

    // Firebase SDK importları
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js';
    import { getFirestore, collection, addDoc, doc, getDoc, onSnapshot, updateDoc, increment, setDoc } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';

    // Firebase başlat
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // UI elemanları
    const emailEl = document.getElementById('email');
    const passwordEl = document.getElementById('password');
    const btnSignUp = document.getElementById('btnSignUp');
    const btnSignIn = document.getElementById('btnSignIn');
    const authButtons = document.getElementById('authButtons');
    const balanceEl = document.getElementById('balance');
    const tasksDiv = document.getElementById('tasks');
    const taskListCard = document.getElementById('taskListCard');
    const adminCard = document.getElementById('adminCard');

    // Kayıt ol
    btnSignUp.addEventListener('click', async () => {
      const email = emailEl.value.trim();
      const password = passwordEl.value;
      if (!email || !password) { alert('Email ve parola gerekli'); return; }
      try {
        const userCred = await createUserWithEmailAndPassword(auth, email, password);
        await setDoc(doc(db, 'users', userCred.user.uid), { email: email, balance: 0 });
        alert('Kayıt başarılı!');
      } catch (e) { console.error(e); alert('Kayıt hatası: ' + e.message); }
    });

    // Giriş yap
    btnSignIn.addEventListener('click', async () => {
      const email = emailEl.value.trim();
      const password = passwordEl.value;
      if (!email || !password) { alert('Email ve parola gerekli'); return; }
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (e) { console.error(e); alert('Giriş hatası: ' + e.message); }
    });

    // Oturum durumunu dinle
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        authButtons.innerHTML = `<div style="font-size:13px">${user.email} <button id="btnLogout" style="margin-left:8px;background:#ef4444;cursor:pointer;">Çıkış</button></div>`;
        document.getElementById('btnLogout').onclick = () => signOut(auth);

        // Kullanıcı bilgisi al
        const udoc = await getDoc(doc(db, 'users', user.uid));
        const ubal = udoc.exists() ? udoc.data().balance || 0 : 0;
        balanceEl.textContent = `Bakiye: ₺${ubal}`;

        taskListCard.style.display = 'block';

        if (user.email === ADMIN_EMAIL) adminCard.style.display = 'block';
        else adminCard.style.display = 'none';

        startTasksListener();
      } else {
        authButtons.innerHTML = '';
        balanceEl.textContent = 'Bakiye: ₺0';
        taskListCard.style.display = 'none';
        adminCard.style.display = 'none';
        tasksDiv.innerHTML = '';
      }
    });

    // Görevleri dinle
    let unsubscribeTasks = null;
    function startTasksListener() {
      if (unsubscribeTasks) unsubscribeTasks();
      const tasksCol = collection(db, 'tasks');
      unsubscribeTasks = onSnapshot(tasksCol, (snap) => {
        tasksDiv.innerHTML = '';
        snap.forEach(docSnap => {
          const t = { id: docSnap.id, ...docSnap.data() };
          renderTask(t);
        });
      });
    }

    // Görevleri göster
    function renderTask(task) {
      const el = document.createElement('div');
      el.className = 'card';
      el.innerHTML = `
        <div><strong>${escapeHtml(task.title)}</strong></div>
        <div class="small muted">${escapeHtml(task.description || '')}</div>
        <div style="margin-top:8px">Ödül: ₺${task.reward}</div>`;

      const actions = document.createElement('div');
      actions.className = 'task-actions';
      const btn = document.createElement('button');
      btn.textContent = 'Tamamla';
      btn.onclick = () => completeTask(task.id, task.reward);
      actions.appendChild(btn);
      el.appendChild(actions);

      tasksDiv.appendChild(el);
    }

    // Görev tamamla ve bakiye güncelle (basit ödeme yöntemi olarak)
    async function completeTask(taskId, reward) {
      const user = auth.currentUser;
      if (!user) { alert('Lütfen giriş yapın'); return; }
      try {
        const compRef = doc(db, 'users', user.uid, 'completions', taskId);
        const compSnap = await getDoc(compRef);
        if (compSnap.exists()) { alert('Bu görevi zaten tamamladınız.'); return; }

        await setDoc(compRef, { taskId: taskId, completedAt: new Date().toISOString(), reward: Number(reward) });

        const userRef = doc(db, 'users', user.uid);
        await updateDoc(userRef, { balance: increment(Number(reward)) });

        const newUserSnap = await getDoc(userRef);
        const newBal = newUserSnap.data().balance;
        balanceEl.textContent = `Bakiye: ₺${newBal}`;

        alert('Tebrikler! Görev tamamlandı ve bakiye eklendi.');
      } catch (e) {
        console.error(e);
        alert('Tamamlama hatası: ' + e.message);
      }
    }

    // Admin: görev ekle
    document.getElementById('btnAddTask').addEventListener('click', async () => {
      const title = document.getElementById('taskTitle').value.trim();
      const desc = document.getElementById('taskDesc').value.trim();
      const reward = Number(document.getElementById('taskReward').value);
      if (!title || !reward) { alert('Başlık ve ödül gerekli'); return; }
      try {
        await addDoc(collection(db, 'tasks'), { title: title, description: desc, reward: reward, createdAt: new Date().toISOString() });
        document.getElementById('taskTitle').value = '';
        document.getElementById('taskDesc').value = '';
        document.getElementById('taskReward').value = '';
        alert('Görev eklendi');
      } catch (e) {
        console.error(e);
        alert('Ekleme hatası: ' + e.message);
      }
    });

    // Basit HTML escape fonksiyonu
    function escapeHtml(text) {
      if (!text) return '';
      return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }
  </script>
</body>
</html>
